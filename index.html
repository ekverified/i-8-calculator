<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>i-8 SMART BOT</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: clamp(14px, 2vw, 16px);
    }
    button {
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #218838;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    #result, #amortization-schedule {
      margin-top: 20px;
    }
    .error {
      color: red;
      margin-top: 10px;
    }
    .loading {
      color: blue;
      margin-top: 10px;
    }
    @media (max-width: 600px) {
      input, select, button {
        font-size: clamp(12px, 1.5vw, 14px);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>i-8 SMART BOT</h1>
    <form id="calculator-form">
      <label for="calcType">Calculation Type:</label>
      <select id="calcType" onchange="toggleFormFields()">
        <option value="Deposit">Deposit</option>
        <option value="Existing Loan">Existing Loan</option>
        <option value="New Loan">New Loan</option>
      </select>

      <!-- Deposit/Existing Loan Fields -->
      <div id="deposit-existing-fields">
        <label for="amount">Amount (KES):</label>
        <input type="number" id="amount" min="0" required>
        <label for="dueDate">Due Date:</label>
        <input type="date" id="dueDate" required>
        <label for="checkDate">Check Date:</label>
        <input type="date" id="checkDate" required>
      </div>

      <!-- New Loan Fields -->
      <div id="new-loan-fields" style="display: none;">
        <label for="idNumber">ID Number:</label>
        <input type="text" id="idNumber" required>
        <label for="name">Name:</label>
        <input type="text" id="name" required>
        <label for="email">Email:</label>
        <input type="email" id="email" required>
        <label for="loanType">Loan Type:</label>
        <select id="loanType" onchange="updateRepaymentOptions()">
          <option value="Short">Short Term (5%, 1 month)</option>
          <option value="Medium">Medium Term (10%, 2-3 months)</option>
          <option value="Long">Long Term (15%, 4-12 months)</option>
        </select>
        <label for="repaymentPeriod">Repayment Period (Months):</label>
        <select id="repaymentPeriod">
          <option value="1">1 month</option>
        </select>
        <label for="loanAmount">Amount (KES):</label>
        <input type="number" id="loanAmount" min="0" required>
      </div>

      <button type="submit">Calculate / Submit</button>
    </form>
    <div id="result"></div>
    <div id="amortization-schedule"></div>
    <div id="error" class="error"></div>
    <div id="loading" class="loading"></div>
  </div>

  <script src="https://apis.google.com/js/api.js" defer></script>
  <script>
    // Configuration
    const SPREADSHEET_ID = '1-HLzwKkb6sAtJskBiFn1Fsbp4WrfkLAD10AydcXCj10';
    const CLIENT_ID = '46347675750-tfr3pj2bcvcdv0i3t3i0j2iave9lau2p.apps.googleusercontent.com';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzqePT4Ajc4OSsnQjxY5sTg7JKag0--s-Dcqe_sey4rjP2WsOW9y9traz8ZRRse4gjrrw/exec';
    const VIEW_ONLY_LINK = 'https://docs.google.com/spreadsheets/d/1-HLzwKkb6sAtJskBiFn1Fsbp4WrfkLAD10AydcXCj10/edit?usp=sharing';

    // Toggle form fields
    function toggleFormFields() {
      const calcType = document.getElementById('calcType').value;
      document.getElementById('deposit-existing-fields').style.display = calcType === 'New Loan' ? 'none' : 'block';
      document.getElementById('new-loan-fields').style.display = calcType === 'New Loan' ? 'block' : 'none';
      document.getElementById('result').innerHTML = '';
      document.getElementById('amortization-schedule').innerHTML = '';
      document.getElementById('error').innerHTML = '';
      document.getElementById('loading').innerHTML = '';
      if (calcType === 'New Loan') updateRepaymentOptions();
    }

    // Update repayment period options
    function updateRepaymentOptions() {
      const loanType = document.getElementById('loanType').value;
      const repaymentPeriod = document.getElementById('repaymentPeriod');
      repaymentPeriod.innerHTML = '';
      const options = loanType === 'Short' ? [1] :
                      loanType === 'Medium' ? [2, 3] :
                      [4, 5, 6, 7, 8, 9, 10, 11, 12];
      options.forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.text = `${month} month${month > 1 ? 's' : ''}`;
        repaymentPeriod.appendChild(option);
      });
    }

    // Calculate days between dates
    function getDaysDiff(startDate, endDate) {
      const diffTime = endDate - startDate;
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    // Calculate deposit penalty
    function calculateDepositPenalty(amount, dueDate, checkDate) {
      const daysLate = getDaysDiff(new Date(dueDate), new Date(checkDate));
      let penalty = 0;
      if (daysLate > 0 && daysLate <= 7) {
        penalty = amount * 0.3;
      } else if (daysLate > 7) {
        penalty = amount * 0.3 + amount * 0.01 * (daysLate - 7);
      }
      return { amount, penalty };
    }

    // Calculate existing loan
    function calculateExistingLoan(amount, dueDate, checkDate) {
      const daysLate = getDaysDiff(new Date(dueDate), new Date(checkDate));
      let interestRate = 0.05; // Short Term default
      const calcType = document.getElementById('calcType').value;
      if (calcType.includes('Medium')) interestRate = 0.1;
      else if (calcType.includes('Long')) interestRate = 0.15;
      const interest = amount * interestRate;
      let penalty = 0;
      let rollOverInterest = 0;
      if (daysLate > 7) {
        penalty = amount * 0.005 * (daysLate - 7);
        rollOverInterest = amount * 0.05;
      }
      return { principal: amount, interest, penalty, rollOverInterest };
    }

    // Calculate amortization schedule
    function calculateAmortization(amount, months, loanType) {
      const interestRate = loanType === 'Short' ? 0.05 : loanType === 'Medium' ? 0.1 : 0.15;
      const total = amount * (1 + interestRate);
      const monthly = (total / months).toFixed(2);
      const schedule = [];
      let balance = total;
      for (let i = 1; i <= months; i++) {
        const dueDate = new Date(2025, 7 + i, 8); // Start August 8, 2025
        schedule.push({
          month: i,
          dueDate: dueDate.toISOString().split('T')[0],
          amount: monthly,
          balance: (balance - monthly).toFixed(2)
        });
        balance -= monthly;
      }
      return schedule;
    }

    // Display results
    function displayResults(data, type) {
      let html = '<table><tr>';
      if (type === 'Deposit') {
        html += '<th>Amount (KES)</th><th>Penalty (KES)</th></tr>';
        html += `<tr><td>${data.amount}</td><td>${data.penalty.toFixed(2)}</td></tr>`;
      } else if (type === 'Existing Loan') {
        html += '<th>Principal (KES)</th><th>Interest (KES)</th><th>Penalty (KES)</th><th>Roll-over Interest (KES)</th></tr>';
        html += `<tr><td>${data.principal}</td><td>${data.interest.toFixed(2)}</td><td>${data.penalty.toFixed(2)}</td><td>${data.rollOverInterest.toFixed(2)}</td></tr>`;
      }
      html += '</table>';
      document.getElementById('result').innerHTML = html;
    }

    // Display amortization schedule
    function displayAmortization(schedule) {
      let html = '<h3>Amortization Schedule</h3><table><tr><th>Month</th><th>Due Date</th><th>Amount (KES)</th><th>Balance (KES)</th></tr>';
      schedule.forEach(row => {
        html += `<tr><td>${row.month}</td><td>${row.dueDate}</td><td>${row.amount}</td><td>${row.balance}</td></tr>`;
      });
      html += '</table>';
      document.getElementById('amortization-schedule').innerHTML = html;
    }

    // Initialize Google Sheets API
    function initGapi() {
      if (!window.gapi) {
        document.getElementById('error').innerHTML = 'Failed to load Google API. Please try again.';
        return;
      }
      gapi.load('client:auth2', () => {
        gapi.client.init({
          clientId: CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/spreadsheets',
          discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
        }).then(() => {
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);
          updateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        }).catch(err => {
          document.getElementById('error').innerHTML = 'Google API initialization failed: ' + err.message;
        });
      });
    }

    function updateSignInStatus(isSignedIn) {
      if (!isSignedIn) {
        gapi.auth2.getAuthInstance().signIn().catch(err => {
          document.getElementById('error').innerHTML = 'Google Sign-In failed: ' + err.message;
        });
      }
    }

    // Append loan application
    async function appendLoanApplication(data) {
      try {
        document.getElementById('loading').innerHTML = 'Submitting application...';
        const response = await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: 'Loan Applications!A:I',
          valueInputOption: 'USER_ENTERED',
          resource: {
            values: [[
              data.applicationId, data.idNumber, data.name, data.email,
              data.loanType, data.repaymentPeriod, data.amount,
              new Date().toLocaleString('en-US', {timeZone: 'Africa/Nairobi'}),
              'Pending'
            ]]
          }
        });
        document.getElementById('loading').innerHTML = '';
        return response;
      } catch (err) {
        throw new Error('Failed to append loan application: ' + err.message);
      }
    }

    // Append installments
    async function appendInstallments(data, schedule) {
      try {
        const values = schedule.map(row => [
          data.applicationId, data.idNumber, row.month, row.dueDate, row.amount, 0, '', row.balance
        ]);
        const response = await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: 'Installments!A:H',
          valueInputOption: 'USER_ENTERED',
          resource: { values }
        });
        return response;
      } catch (err) {
        throw new Error('Failed to append installments: ' + err.message);
      }
    }

    // Trigger Apps Script for notifications
    async function sendNotifications(data) {
      try {
        document.getElementById('loading').innerHTML = 'Sending notifications...';
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            applicationId: data.applicationId,
            amount: data.amount,
            firstName: data.name.split(' ')[0],
            dateTime: new Date().toLocaleString('en-US', {timeZone: 'Africa/Nairobi'})
          })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message || 'Notification request failed');
        document.getElementById('loading').innerHTML = '';
        document.getElementById('error').innerHTML = 'Application submitted successfully!';
      } catch (err) {
        document.getElementById('loading').innerHTML = '';
        document.getElementById('error').innerHTML = 'Error sending notifications: ' + err.message;
      }
    }

    // Validate inputs
    function validateInputs(data) {
      if (!data.idNumber.match(/^\d{8,10}$/)) return 'Invalid ID Number (8-10 digits)';
      if (!data.email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) return 'Invalid Email';
      if (data.loanType === 'Short' && data.amount < 2000) return 'Short Term loan must be at least 2000 KES';
      if (data.loanType === 'Medium' && data.amount < 5000) return 'Medium Term loan must be at least 5000 KES';
      if (data.loanType === 'Long' && data.amount < 30000) return 'Long Term loan must be at least 30000 KES';
      return null;
    }

    // Form submission
    document.getElementById('calculator-form').addEventListener('submit', async e => {
      e.preventDefault();
      const calcType = document.getElementById('calcType').value;
      document.getElementById('error').innerHTML = '';
      document.getElementById('loading').innerHTML = '';

      if (calcType === 'Deposit' || calcType === 'Existing Loan') {
        const amount = parseFloat(document.getElementById('amount').value);
        const dueDate = document.getElementById('dueDate').value;
        const checkDate = document.getElementById('checkDate').value;
        if (!amount || !dueDate || !checkDate) {
          document.getElementById('error').innerHTML = 'Please fill all fields';
          return;
        }
        if (calcType === 'Deposit') {
          const result = calculateDepositPenalty(amount, dueDate, checkDate);
          displayResults(result, 'Deposit');
        } else {
          const result = calculateExistingLoan(amount, dueDate, checkDate);
          displayResults(result, 'Existing Loan');
        }
      } else {
        const data = {
          applicationId: `APP${Date.now()}`,
          idNumber: document.getElementById('idNumber').value,
          name: document.getElementById('name').value,
          email: document.getElementById('email').value,
          loanType: document.getElementById('loanType').value,
          repaymentPeriod: parseInt(document.getElementById('repaymentPeriod').value),
          amount: parseFloat(document.getElementById('loanAmount').value)
        };
        const error = validateInputs(data);
        if (error) {
          document.getElementById('error').innerHTML = error;
          return;
        }
        const schedule = calculateAmortization(data.amount, data.repaymentPeriod, data.loanType);
        displayAmortization(schedule);
        try {
          await appendLoanApplication(data);
          await appendInstallments(data, schedule);
          await sendNotifications(data);
        } catch (err) {
          document.getElementById('error').innerHTML = err.message;
        }
      }
    });

    // Initialize on load
    window.addEventListener('load', () => {
      try {
        initGapi();
      } catch (err) {
        document.getElementById('error').innerHTML = 'Initialization failed: ' + err.message;
      }
    });
  </script>
</body>
</html>